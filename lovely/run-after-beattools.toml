[manifest]
dump_lua = true
priority = 2147483643 # 2147483647 - 4
version = "1.0.0"

# Prepend ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.copy]
position = "prepend"
sources = ["prepend/beattools.lua"]
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''local st = Gamestate:new('Editor')'''
payload = ''''''
position = "at"
target = "states/Editor.lua"

# Update self ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.pattern]
match_indent = true
pattern = '''st:setUpdate(function(self, dt)'''
payload = '''
	if self.menuMusicManager then
		self.menuMusicManager:update(dt)
		if self.beattoolsMenuMusicInEditorOn ~= mods.beattools.config.menuMusicInEditor then
			if mods.beattools.config.menuMusicInEditor then
				self.menuMusicManager.music:play()
			else
				self.menuMusicManager:stop()
			end
		end
		self.beattoolsMenuMusicInEditorOn = mods.beattools.config.menuMusicInEditor
	end
	beattoolsTime = beattoolsTime + dt
	if self.editMode then
		--[[if beattoolsPlayerSprite == "idle" then
			if (beattoolsTime - beattoolsLastSpriteChange) / 60 > 8 - 0.1 then
				beattoolsPlayerSprite = "closed"
				beattoolsLastSpriteChange = beattoolsTime
			end
		elseif beattoolsPlayerSprite == "closed" then
			if (beattoolsTime - beattoolsLastSpriteChange) / 60 > 0.1 then
				beattoolsPlayerSprite = "idle"
				beattoolsLastSpriteChange = beattoolsTime
			end
		else]]if beattoolsPlayerSprite == "><" then
			if (beattoolsTime - beattoolsLastSpriteChange) / 60 > 1 then
				beattoolsPlayerSprite = "idle"
				beattoolsLastSpriteChange = beattoolsTime
			end
		end
		if mods.beattools.config.currentSprite then self:beattoolsCurrentEasing("playerSprites", "spriteName", "editorBeat") end

		-- Penta: This code is not optimised, but it doesnt have to be, "lively cranky" is just for fun
		if mods.beattools.config.livelyCranky and beattoolsPlayerSprite == "><" then
			self.p.forceSprite = beattoolsPlayerSprite
		elseif mods.beattools.config.livelyCranky and maininput:down("modifier") then
			self.p.forceSprite = "happy"
		else
			local forcedSprite = false
			if mods.beattools.config.currentSprite and self.beattoolsCurrentEasings.editorBeat.playerSprites.spriteName ~= "" then
				local spriteName = self.beattoolsCurrentEasings.editorBeat.playerSprites.spriteName
				if spriteName:sub(-4):lower() == ".png" then
					local filename = cLevel .. spriteName
					if love.filesystem.exists(filename) then
						local modTime = love.filesystem.getInfo(cLevel .. spriteName, "file").modtime
						if beattoolsPlayerSpriteChanged[spriteName] ~= modTime then
							beattoolsLastSpriteModified = beattoolsTime
							beattoolsPlayerSpriteChanged[spriteName] = modTime
						end
						if cs.p.spr[spriteName] == nil or (beattoolsTime - beattoolsLastSpriteModified) / 60 > 1 then
							cs.p.spr[spriteName] = love.graphics.newImage(filename)
						end
					end
				end

				if ({ [""] = true, none = true, idle = true, happy = true, miss = true, ["><"] = true, [":3"] = true })[spriteName] or cs.p.spr[spriteName] ~= nil then
					cs.p.forceSprite = spriteName
					cs.p.useFaceStencil = self.beattoolsCurrentEasings.editorBeat.playerSprites.useFaceStencil
					forcedSprite = true
				end
			end
			if not forcedSprite then
				--[[if mods.beattools.config.livelyCranky and beattoolsTime - ((#beattoolsChangeList > 0 and beattoolsChangeList[#beattoolsChangeList].time) or 0) > 60 * 60 then
					self.p.forceSprite = "sleep"
				else]]if mods.beattools.config.livelyCranky then
					self.p.forceSprite = beattoolsPlayerSprite
				else
					self.p.forceSprite = ""
				end
			end
		end
	end
'''
position = "after"
target = "states/Editor.lua"

# Remove help marker ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.regex]
pattern = '''(imgui.SameLine\(\)[\n\s]+)?helpers\.imguiHelpMarker'''
payload = '''utilitools.imguiHelpers.tooltip'''
position = "at"
target = "states/Editor.lua"

[[patches]]
[patches.regex]
pattern = '''(?:bgData|(?:self\.(?:level\.(?:metadata|properties)|variant?)))\.\w+ = helpers\.Input(?:Text|Int|Float)\((?<label>['"][\w\s#]+['"])'''
payload = '''if mods.beattools.config.fullSize then utilitools.imguiHelpers.setWidth( $label --[[Penta's RegEx Marker]]) end '''
position = "before"
target = "states/Editor.lua"

[[patches]]
[patches.regex]
pattern = '''bgData\.\w+Channel\.r, bgData\.\w+Channel\.g, bgData\.\w+Channel\.b = helpers\.imguiColor\((?:[\n\s\t]*)?(?<label>['"]\w+ channel['"])'''
payload = '''if mods.beattools.config.fullSize then utilitools.imguiHelpers.setWidth( $label --[[Penta's RegEx Marker]]) end '''
position = "before"
target = "states/Editor.lua"

[[patches]]
[patches.regex]
pattern = '''##float(?<keep>\w+['"] --\[\[Penta's RegEx Marker\]\])'''
payload = '''$keep'''
position = "at"
target = "states/Editor.lua"

[[patches]]
[patches.regex]
pattern = '''(?<keep>(Charter|offset|Speed|beat)['"]) --\[\[Penta's RegEx Marker\]\]'''
payload = '''$keep , not mods.beattools.config.hideHelpMarkers'''
position = "at"
target = "states/Editor.lua"

# Tag and blueprint compatibility without Editor Shortcuts ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.pattern]
match_indent = true
pattern = '''for i, v in ipairs(tagEvents) do
	v.time = v.time - self.multiselectStartBeat
end'''
payload = '''
if mods.beattools.config.fakeRepeat then
	for i = #tagEvents, 1, -1 do
		local v = tagEvents[i]
		if v.beattoolsRepeatChild ~= nil then
			table.remove(tagEvents, i)
		end
	end
end
for i = 1, #tagEvents do
	local v = tagEvents[i]
	v.time = v.time - (self.multiselectStartBeat or self.selectedEvent.time)
	if mods.beattools.config.fakeRepeat then
		if v.beattoolsRepeatParent and v.repeats ~= nil and v.repeats > 0 and not utilitools.files.beattools.eventVisuals.hasRepeat[v.type] then
			for i = 1, v.repeats do
				local newEvent = helpers.copy(v)

				newEvent.beattoolsRepeatParent, newEvent.repeats, newEvent.repeatDelay = nil, nil, nil
				newEvent.time = v.time + i * (v.repeatDelay or 1)
				newEvent.beattoolsRepeatChild = v.beattoolsRepeatParent

				table.insert(tagEvents, 1, newEvent)
				i = i + 1
			end
		else
			v.beattoolsRepeatParent = nil
		end
	end
end
'''
position = "at"
target = "states/Editor.lua"

# Edits the event position visually ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.pattern]
match_indent = true
pattern = '''
for i, v in ipairs(self.level.events) do --draw events
	if Event.info[v.type] and Event.checkActiveRange[v.type](v, self.editorBeat, self.editorBeat + self.drawDistance) then
		local gameplay = Event.info[v.type].gameplayLayer
		if gameplay == nil then
			gameplay = Event.info[v.type].storeInChart
		end
		if gameplay then
			love.graphics.setCanvas(self.layerCanvas.gameplay)
		else
			love.graphics.setCanvas(self.layerCanvas.vfx)
		end
		self:drawEvent(v)

		if self.multiselect then
			for ii, vv in ipairs(self.multiselect.events) do
				if v == vv then
					local pos = self:getPosition(v.angle, v.time)
					love.graphics.draw(sprites.editor.selected, pos[1], pos[2], 0, 1, 1, 11, 11)
				end
			end
		end
	end
end
love.graphics.setCanvas(self.canv)

--draw layers
love.graphics.setColor(1,1,1,0.3)
if self.layers.vfx == 2 then
	love.graphics.draw(self.layerCanvas.vfx)
end
if self.layers.gameplay == 2 then
	love.graphics.draw(self.layerCanvas.gameplay)
end

love.graphics.setColor(1,1,1,1)
if self.layers.vfx == 1 then
	love.graphics.draw(self.layerCanvas.vfx)
end
if self.layers.gameplay == 1 then
	love.graphics.draw(self.layerCanvas.gameplay)
end

--redraw selected event on top
if self.selectedEvent and self.editorBeat <= self.selectedEvent.time then
	local pos = {0, 0}
	if not self.holdEndSelected then
		pos = self:getPosition(self.selectedEvent.angle, self.selectedEvent.time)
	else
		local pos = self:getPosition(self.selectedEvent.angle2, self.selectedEvent.time + self.selectedEvent.duration)
	end
	self:drawEvent(self.selectedEvent)
	love.graphics.draw(sprites.editor.selected, pos[1], pos[2], 0, 1, 1, 11, 11)
end


--draw cursor event
if self.placeEvent ~= '' and not imgui.love.GetWantCaptureMouse() then
	local eventAlpha = 0.5
	if self.blockPlacement then
		eventAlpha = 0.25
	end
	self:drawCursorEvent(self.placeEvent,self.cursorAngle,self.cursorBeat,eventAlpha)
end
'''
payload = '''utilitools.files.beattools.eventVisuals.drawEvents()'''
position = "at"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''
function st:drawCursorEvent(eventType,angle,time,alpha)
	self:drawEvent({type = eventType, angle = angle, time = time, isCursor = true},alpha)
end
'''
payload = ""
position = "at"
target = "states/Editor.lua"

# Update biggest beat ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.pattern]
match_indent = true
pattern = '''  color(cs.voidColor)'''
payload = '''
	love.graphics.setFont(fonts.main)
	if self.editMode then
		love.graphics.setColor(mods.beattools.config.editorBgColor.r, mods.beattools.config.editorBgColor.g, mods.beattools.config.editorBgColor.b, 1)
	else
		color(cs.voidColor)
	end
'''
position = "at"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''--trigger auto-backup every five minutes'''
payload = '''
utilitools.files.beattools.undo.update()
'''
position = "before"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''function st:updateBiggestBeat()'''
payload = '''
	for k, v in pairs(beattoolsDefaultEasings) do
		self.beattoolsEasings[k] = {}
	end
	self.beattoolsCurrentEasings = {}
'''
position = "after"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''self.smallestBeat = math.min(self.smallestBeat, v.time)'''
payload = '''
if beattoolsTrackEasables[v.type] then beattoolsTrackEasables[v.type](v, i) end

if mods.beattools.config.autoFixSides and v.type == "side" then
	local prev = v.endAngle or v.angle
	local after = prev % 360
	if after ~= prev then
		v[v.endAngle and "endAngle" or "angle"] = after
		if v.endAngle then
			v.angle = v.angle + (after - prev)
		end
	end
end
-- Penta's Beattools code marker
'''
position = "after"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = false
pattern = '''	-- Penta's Beattools code marker
end'''
payload = '''
	for kk, vv in pairs(self.beattoolsEasings) do
		if beattoolsEasingFor[kk] == true then
			table.sort(vv, function (a, b) return a.time + (a.order or 0) / 10000 < b.time + (b.order or 0) / 10000 end)
		elseif type(beattoolsEasingFor[kk]) == "table" then
			for kkk, vvv in beattoolsEasingFor[kk][1](vv) do
				if vvv ~= nil then
					for kkkk, vvvv in beattoolsEasingFor[kk][2](vvv) do
						if vvvv ~= nil then table.sort(vvvv, function (a, b) return a.time + (a.order or 0) / 10000 < b.time + (b.order or 0) / 10000 end) end
					end
				end
			end
		else
			for kkk, vvv in beattoolsEasingFor[kk](vv) do
				if vvv ~= nil then table.sort(vvv, function (a, b) return a.time + (a.order or 0) / 10000 < b.time + (b.order or 0) / 10000 end) end
			end
		end
	end
'''
position = "after"
target = "states/Editor.lua"

# Making the seletion hitbox offset as well ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.pattern]
match_indent = true
pattern = '''
if helpers.collide(
	{ x = mouse.rx, y = mouse.ry, width = 0, height = 0 },
	{ x = pos[1] - 8, y = pos[2] - 8, width = 16, height = 16 }'''
payload = '''
if ((not mods.beattools.config.fakeRepeat) or v.beattoolsRepeatChild == nil) and not ({ ghost = true, hide = true })[utilitools.files.beattools.eventGroups.eventVisibility(v)] and helpers.collide(
	{ x = mouse.rx, y = mouse.ry, width = 0, height = 0 },
	{ x = pos[1] - 8 + utilitools.files.beattools.eventStacking.getIndex(v) * mods.beattools.config.xOffset, y = pos[2] - 8 - utilitools.files.beattools.eventStacking.getIndex(v) * mods.beattools.config.yOffset, width = 16, height = 16 }
'''
position = "at"
target = "states/Editor.lua"
# currently expect 1 default match and 1 match for "Hold Dragging" v1.0.0 by Kakadu and "Ctrl Select" v1.2.0 by Kakadu each
# Penta: hmmm with EA, not anymore, uhhh

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''if ((v.type == "hold") or (v.type == "mineHold") or (v.type == "trace")) and v.angle2 then'''
payload = '''if ((v.type == "hold") or (v.type == "mineHold") or (v.type == "trace")) and v.angle2 and ((not mods.beattools.config.fakeRepeat) or v.beattoolsRepeatChild == nil) and not ({ ghost = true, hide = true })[utilitools.files.beattools.eventGroups.eventVisibility(v)] then'''
position = "at"
target = "states/Editor.lua"

[[patches]]
[patches.regex]
pattern = '''(?<func>table\.insert\(\w+?)\.multiselect\.events, ?(?<event>[\s\S]+?)\)(?<end>(\s|--\[\[[\s\S]*?\]\]|--[\s\S]*?\n)*?\w+)'''
payload = '''if ((not mods.beattools.config.fakeRepeat) or $event.beattoolsRepeatChild == nil) and not ({ ghost = true, hide = true })[utilitools.files.beattools.eventGroups.eventVisibility($event)] then $func .multiselect.events, $event ) end $end'''
position = "at"
target = "states/Editor.lua"

# Updating stack detection more often ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.pattern]
match_indent = true
pattern = '''if maininput:pressed("move_up") then'''
payload = '''self:updateBiggestBeat()'''
position = "before"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''if maininput:pressed("move_down") then'''
payload = '''self:updateBiggestBeat()'''
position = "before"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''self.selectedEvent.angle = angle'''
payload = '''
local beattoolsTemp = false
if self.selectedEvent.angle ~= self.cursorAngle or self.selectedEvent.time ~= self.cursorBeat then beattoolsTemp = true end
'''
position = "before"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''self.selectedEvent.time = self.cursorBeat'''
payload = '''if beattoolsTemp then self:updateBiggestBeat() end'''
position = "after"
target = "states/Editor.lua"

# Dont save parameters ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
# [[patches]]
# [patches.pattern]
# match_indent = true
# pattern = '''v.play_onBeat = nil'''
# payload = '''
# -- Penta:
# -- here's where i would remove parameters i didnt want save in the level files
# -- IF I HAD SOME!!! :(   /ref
# '''
# position = "after"
# target = "obj/LevelManager.lua"

# [[patches]]
# [patches.pattern]
# match_indent = true
# pattern = '''local upgraded = LevelManager:saveLevel(self.level, cLevel, self.forceSaveBoth, self.variant)'''
# payload = '''-- self:updateBiggestBeat()'''
# position = "after"
# target = "states/Editor.lua"

# [[patches]]
# [patches.pattern]
# match_indent = true
# pattern = '''LevelManager:saveLevel(self.level, cLevel, true, self.variant)'''
# payload = '''-- self:updateBiggestBeat()'''
# position = "after"
# target = "states/Editor.lua"

# [[patches]]
# [patches.pattern]
# match_indent = true
# pattern = '''LevelManager:saveLevel(self.level, cLevel..backup, true, self.variant)'''
# payload = '''-- self:updateBiggestBeat()'''
# position = "after"
# target = "states/Editor.lua"

# End angle fix ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.regex]
pattern = '''(?<func>self:getPosition)\((?<param>[^\n]+?)\.angle,'''
payload = '''
self:getPosition((mods.beattools.config.displayEndAngle and $param.endAngle or $param.angle),'''
position = "at"
target = "states/Editor.lua"

# Random Menus ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.regex]
line_prepend = "$indent"
pattern = '''[^\S\n]*helpers\.SetNextWindowPos\([^\S\n]*?(?<param1>\d+)[^\S\n]*?,[^\S\n]*?(?<param2>\d+)[^\S\n]*?,[^\S\n]*?(?<param3>[\w"'_ ]+?)[^\S\n]*?\)[^\S\n]*?\n(?<indent>\s+)helpers\.SetNextWindowSize\([^\S\n]*?(?<param5>\d+)[^\S\n]*?,[^\S\n]*?(?<param6>\d+)[^\S\n]*?,[^\S\n]*?(?<param7>[\w"'_ ]+?)[^\S\n]*?\)'''
payload = '''
if mods.beattools.config.randomizeWindows ~= "off" and beattoolsRandomizeWindows then
	local sx, sy = math.random(100, 400), math.random(100, 400)
	helpers.SetNextWindowPos(math.random(0, 1200 - sx), math.random(0, 720 - sy), "ImGuiCond_Always")
	helpers.SetNextWindowSize(sx, sy, "ImGuiCond_Always")
else
	helpers.SetNextWindowPos( $param1 , $param2 , $param3 )
	helpers.SetNextWindowSize( $param5 , $param6 , $param7 )
end
'''
position = "at"
target = "states/Editor.lua"

# Permanent Menus ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.regex]
line_prepend = "$indent"
pattern = '''(?<rest>imgui\.Begin\(("[^\n]*?"|'[^\n]*?'|self.errorHeader))\)'''
payload = '''$rest , nil, (mods.beattools.config.stopImGuiMove and imgui.ImGuiWindowFlags_NoMove or 0) + (mods.beattools.config.stopImGuiResize and imgui.ImGuiWindowFlags_NoResize or 0))'''
position = "at"
target = "states/Editor.lua"

[[patches]]
[patches.regex]
line_prepend = "$indent"
pattern = '''(?<rest>imgui\.Begin\(("[^\n]*?"|'[^\n]*?'|self.errorHeader), ?\w+)\)'''
payload = '''$rest , (mods.beattools.config.stopImGuiMove and imgui.ImGuiWindowFlags_NoMove or 0) + (mods.beattools.config.stopImGuiResize and imgui.ImGuiWindowFlags_NoResize or 0))'''
position = "at"
target = "states/Editor.lua"

[[patches]]
[patches.regex]
line_prepend = "$indent"
pattern = '''(?<rest>imgui\.Begin\(("[^\n]*?"|'[^\n]*?'|self.errorHeader), ?\w+), ?inputFlag\)'''
payload = '''$rest , (inputFlag or 0) + (mods.beattools.config.stopImGuiMove and imgui.ImGuiWindowFlags_NoMove or 0) + (mods.beattools.config.stopImGuiResize and imgui.ImGuiWindowFlags_NoResize or 0))'''
position = "at"
target = "states/Editor.lua"

# Editor Colors ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.pattern]
match_indent = true
pattern = '''love.graphics.setColor(0.75, 0.75, 0.75, 1)'''
payload = '''love.graphics.setColor(mods.beattools.config.editorSnapColor.r, mods.beattools.config.editorSnapColor.g, mods.beattools.config.editorSnapColor.b, 1)'''
position = "at"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''color('black')'''
payload = '''love.graphics.setColor(mods.beattools.config.editorBlackColor.r, mods.beattools.config.editorBlackColor.g, mods.beattools.config.editorBlackColor.b, 1)'''
position = "at"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''color()'''
payload = '''love.graphics.setColor(mods.beattools.config.editorBgColor.r, mods.beattools.config.editorBgColor.g, mods.beattools.config.editorBgColor.b, 1)'''
position = "at"
target = "states/Editor.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''color('white')'''
payload = '''love.graphics.setColor(mods.beattools.config.editorBgColor.r, mods.beattools.config.editorBgColor.g, mods.beattools.config.editorBgColor.b, 1)'''
position = "at"
target = "states/Editor.lua"

# Text deco inconsistency fix ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== ===== =====
[[patches]]
[patches.pattern]
match_indent = true
pattern = '''
local function editorDraw(event)
	local pos = cs:getPosition(event.angle,event.time)

	love.graphics.draw(sprites.editor.events.textdeco,pos[1],pos[2],0,1,1,8,8)
end
'''
payload = '''local editorDraw = sprites.editor.events.textdeco'''
position = "at"
target = "levelformat/events/Vfx/textdeco.lua"

[[patches]]
[patches.pattern]
match_indent = true
pattern = '''
local function editorDraw(event)
	local pos = cs:getPosition(event.angle,event.time)

	love.graphics.draw(sprites.editor.events.advancetextdeco,pos[1],pos[2],0,1,1,8,8)
end
'''
payload = '''local editorDraw = sprites.editor.events.advancetextdeco'''
position = "at"
target = "levelformat/events/Vfx/advancetextdeco.lua"
